variables:
    GIT_SUBMODULE_STRATEGY: recursive

stages:
    - test
    - publish
    - container_scanning

gitguardianscan:
    image: gitguardian/ggshield:v1.13.5@sha256:82b46a5ebda17645a8aabd3d20cfb65cd65938db4fb6d31275bc91132ff21472
    stage: test
    script: ggshield secret scan ci

jest:
    image: node:18@sha256:9d8a6466c6385e05f62f8ccf173e80209efb0ff4438f321f09ddf552b05af3ba
    stage: test
    script:
        - npm ci --include=dev
        - "npx jest --ci --reporters=default --reporters=jest-junit"
    artifacts:
        when: always
        reports:
            junit:
                - junit.xml

.build-template:
    stage: publish
    needs: [jest, gitguardianscan]
    dependencies:
        - jest
        - gitguardianscan
    image:
        name: gcr.io/kaniko-project/executor:v1.9.1-debug@sha256:ac169723b2076f9d5804f4bc05c98397e286da6fdcdd5a09fdc179f06ccb3be1
        entrypoint: [""]
    script:
        - /kaniko/executor
          --cleanup
          --context $CI_PROJECT_DIR
          --dockerfile $CI_PROJECT_DIR/Dockerfile
          --destination $IMAGE_TAG

build-dev:
    extends: .build-template
    variables:
        IMAGE_TAG: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME
    only:
        - dev

build-main:
    extends: .build-template
    variables:
        IMAGE_TAG: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME
    only:
        - main
    when: manual

build-tag:
    extends: .build-template
    variables:
        IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
    only:
        - tags
    when: manual

helm:
  stage: publish
  image: dtzar/helm-kubectl:3.10.0@sha256:489617317614daad6181603d55319c35529b9d41bfc4a23a11e8e3109a5f5588
  before_script:
    - 'helm repo add --username gitlab-ci-token --password ${CI_JOB_TOKEN} ${CI_PROJECT_NAME} ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/stable'
    - helm dependency update ./helm-chart
  script:
    - 'helm plugin install https://github.com/chartmuseum/helm-push.git'
    - ./helm-package-and-push.sh
  only:
    - tags

.trivy-template:
  stage: container_scanning
  image: aquasec/trivy:0.32.1@sha256:418e71f4895cc6f83f824a313e3bbfdd66bd3d9b843678059340361e74f42355
  script:
    - trivy --severity HIGH,CRITICAL --no-progress --ignore-unfixed --ignorefile .trivyignore --format template --template "@/trivy.tpl" $IMAGE_TAG

trivy-dev:
  extends: .trivy-template
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME
  only:
    - dev

trivy-main:
  extends: .trivy-template
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME
  only:
    - main

trivy-tag:
  extends: .trivy-template
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
  only:
    - tags
